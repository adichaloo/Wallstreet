from .models import *def match(company, user, bidPrice, noShares, buySell):    # Initialize    buyTable = ""    sellTable = ""    exec("buyTable = BuyTable_" + company.tempName)    exec("sellTable = SellTable_" + company.tempName)    # User Preprocessing    if buySell:        # Buy bid        moneyAlter(user, bidPrice * noShares, False)  # Subtract money for user        buyTable.objects.create(company=company.pk, profile=user, bidShares=noShares,                                bidPrice=bidPrice)  # Add entry to buyTable    else:        # Sell bid        u = UserShareTable.objects.get(company=company, profile=user)  # Get entry in userShareTable to remove shares        if noShares < u.bidShares:            # Check If selling lesser number of shares than present            u.bidShares -= noShares            u.save()        elif noShares == u.bidShares:            u.delete()        sellTable.objects.create(company=company.pk, profile=user, bidShares=noShares,                                 bidPrice=bidPrice)  # Create a sellTable Entry    sorted_buyTable = buyTable.objects.all().order_by('-bidPrice', 'timestamp')  # Sort BuyTable Entries    sorted_sellTable = sellTable.objects.all().order_by('bidPrice', 'timestamp')  # Sort SellTable Entries    if sorted_buyTable:        # If buying bids exist        i = 0  # Counter for sorted_buyTable        j = 0  # counter for sorted_sellTable        while i < len(sorted_buyTable) and (j < len(sorted_sellTable) or company.sharesLeft):            # Matching entries as long as possible            if company.sharesLeft:                # if company has shares to sell                if not sorted_sellTable:                    # If sorted_sellTable is empty check for company                    if sorted_buyTable[i].bidPrice > company.sharePrice:                        # Buy Request is greater than comapany current price                        flag = userCompanyTrasaction(company, buyTable, sorted_buyTable[                            i])  # Perform transaction for company and buying user                        i = i + (flag == 0)  # Update counter only if buyTable entry deleted                        continue                # If sorted_sellTable has entry, but company.sharePrice is lesser than sellTable entry then                # sell shares of company                elif company.sharePrice < sorted_sellTable[j].bidPrice and sorted_buyTable[                    i].bidPrice > company.sharePrice:                    # User Match with sorted_buyTable[i] with company shares ( company shares is least priced )                    flag = userCompanyTrasaction(company, buyTable,                                                 sorted_buyTable[i])  # Perform transaction for company and buying user                    i = i + (flag == 0)  # Update counter only if buyTable entry deleted                    continue            if sorted_sellTable and sorted_buyTable[i].bidPrice > sorted_sellTable[j].bidPrice:                # User Match with sorted_buyTable[i] and sorted_sellTable[j]                flag = userTransaction(company, buyTable, sellTable, sorted_buyTable[i],                                       sorted_sellTable[j])  # Perform Transaction                i = i + (flag == -1 or flag == 0)                j = j + (flag == 1 or flag == 0)                # Based on the flag if buy shares are less then buy entry is deleted and i is incremented                # Based on the flag if buy shares are more then sell entry is deleted and j is incremented                # if flag is 0 then both are entries are delted and i,j are incremented            else:                # None of the buy bids are higher than the sell bids (including company share price)                breakdef userCompanyTrasaction(company, buyTable, buyObject):    # Transaction between buying user and company    # Update company share price    company.sharePrice = buyObject.bidPrice    company.save()    # get user    userBuy = Profile.objects.get(pk=buyObject.profile.pk)    try:        # Check if user already has shares of that company        # Update share table accordingly        u = UserShareTable.objects.get(profile=userBuy, company=company)        u.bidShares += min(buyObject.bidShares, company.sharesLeft)        u.save()    except:        # User does not have shares of that comapany        UserShareTable.objects.create(profile=userBuy, company=company, bidShares=buyObject.bidShares)    if buyObject.bidShares <= company.sharesLeft:        # All shares of user buy object sold        UserHistory.objects.create(profile=userBuy, company=company, bidShares=buyObject.bidShares,                                   bidPrice=buyObject.bidPrice, buySell=True)        company.sharesLeft -= buyObject.bidShares  # Update company shares        company.save()        buyTable.objects.get(pk=buyObject.pk).delete()  # Delete entry from buy table        return 0    else:        # User wants to buy more shares than available        buyObject.bidShares -= company.sharesLeft  # Update number of shares in buyTable entry        buyObject.save()        # Update user history        UserHistory.objects.create(profile=userBuy, company=company, bidShares=company.sharesLeft,                                   bidPrice=buyObject.bidPrice, buySell=True)        company.sharesLeft = 0  # Update company shares        company.save()        return 1def userTransaction(company, buyTable, sellTable, buyObject, sellObject):    # Transaction between buying user and selling user    # Update company share price    company.sharePrice = buyObject.bidPrice    company.save()    userBuy = Profile.objects.get(pk=buyObject.profile.pk)  # Get buying user    userSell = Profile.objects.get(pk=sellObject.profile.pk)  # Get selling user    try:        # Check if user already has shares of that company        # Update share table accordingly        u = UserShareTable.objects.get(profile=userBuy, company=company)        u.bidShares += min(buyObject.bidShares, sellObject.bidShares)        u.save()    except:        # User does not have shares of that comapany        UserShareTable.objects.create(profile=userBuy, company=company, bidShares=buyObject.bidShares)    moneyAlter(userSell, sellObject.bidPrice * sellObject.bidShares, True)  # Add money to the selling users price    if buyObject.bidShares == sellObject.bidShares:        # Number of buying and selling shares are equal        # Create User History for buying user and selling user        UserHistory.objects.create(profile=userBuy, company=company, bidShares=buyObject.bidShares,                                   bidPrice=buyObject.bidPrice, buySell=True)        UserHistory.objects.create(profile=userSell, company=company, bidShares=sellObject.bidShares,                                   bidPrice=sellObject.bidPrice, buySell=False)        # Delete buyTable entries and sellTable entries        buyTable.objects.get(pk=buyObject.pk).delete()        sellTable.objects.get(pk=sellObject.pk).delete()        return 0    elif buyObject.bidShares > sellObject.bidShares:        # Number of buy shares are more than number of sell shares        # Update buyTable Entry => number of shares        buyObject.bidShares -= sellObject.bidShares        buyObject.save()        # Create User History        UserHistory.objects.create(profile=userBuy, company=company, bidShares=sellObject.bidShares,                                   bidPrice=buyObject.bidPrice, buySell=True)        UserHistory.objects.create(profile=userSell, company=company, bidShares=sellObject.bidShares,                                   bidPrice=sellObject.bidPrice, buySell=False)        # Delete sellTable Entry        sellTable.objects.get(pk=sellObject.pk).delete()        # Return Flag        return 1    else:        # Number of buy shares are less than number of sell shares        # Update sellTable Entry => number of shares        sellObject.bidShares -= buyObject.bidShares        sellObject.save()        # Create User History        UserHistory.objects.create(profile=userBuy, company=company, bidShares=buyObject.bidShares,                                   bidPrice=buyObject.bidPrice, buySell=True)        UserHistory.objects.create(profile=userSell, company=company, bidShares=buyObject.bidShares,                                   bidPrice=sellObject.bidPrice, buySell=False)        # Delete sellTable Entry        buyTable.objects.get(pk=buyObject.pk).delete()        # return flag        return -1def moneyAlter(user, amount, addSubtract):    # addSubtract = 1 => Add money    # addSubtract = 0 => Subtract Money    cut = amount * 0.01    amount = amount - cut    if addSubtract:        user.cash = user.cash + amount    else:        user.cash = user.cash - amount    user.save()